# CLAUDE.md

이 파일은 Claude Code (claude.ai/code)가 이 저장소에서 작업할 때 지침을 제공합니다.

## 개발 규칙

### 커밋 메시지 규칙
- **모든 커밋 메시지는 한국어로 작성**
- 제목: 간결한 변경사항 요약 (50자 이내)
- 본문: 상세한 변경 내용과 이유 설명
- 예시: "폴더 비교 시 빈 폴더 정리 체크박스 기능 추가"

### 로그 메시지 규칙
- 사용자 대면 로그는 한국어로 작성 (이미 적용됨)
- 디버그 로그도 가능한 한국어 사용
- 이모지를 활용하여 로그 종류 구분 (✅, ❌, ⚠️, 🔍 등)

## 명령어

### 빌드 및 실행
```bash
# 의존성 설치
go mod tidy

# 애플리케이션 실행
go run .

# 바이너리 빌드
go build -o go-drive-duplicates .

# 빌드된 바이너리 실행
./go-drive-duplicates
```

### 테스트 및 린팅
```bash
# Google Drive API 연결 테스트
go run . # 로그에서 OAuth 성공 여부 확인

# 코드 포맷팅
go fmt ./...

# 코드 검증
go vet ./...

# 모듈 의존성 확인
go mod verify
```

### 데이터베이스 작업
```bash
# SQLite 데이터베이스(drive_duplicates.db)는 자동 생성됨
# 수동 스키마 설정 불필요 - 시작 시 마이그레이션 자동 실행

# 모든 데이터 초기화: 데이터베이스 파일 삭제
rm drive_duplicates.db
```

## 아키텍처 개요

임베디드 웹 서버를 사용하는 단일 바이너리 아키텍처로 Google Drive의 중복 파일을 찾고 관리하는 Go 웹 애플리케이션입니다.

### 핵심 구성요소

**main.go**: HTTP 서버 및 라우트 핸들러
- sync.Once를 사용한 전역 DriveService 인스턴스 초기화
- 파일 작업, 스캔, 폴더 비교를 위한 모든 REST API 엔드포인트 처리
- 워커 풀 설정 및 설정 관리
- 정적 파일 및 HTML 템플릿 서빙

**drive.go**: Google Drive 통합 및 비즈니스 로직
- `DriveService` 구조체가 모든 Google Drive API 작업과 SQLite 데이터베이스 캡슐화
- 체크포인트 시스템을 사용한 재개 가능한 파일 스캔
- 설정 가능한 워커 풀과 재시도 로직을 사용한 SHA-256 해시 계산
- 진행 추적 및 결과 캐싱을 포함한 폴더 비교 시스템
- 스마트 폴더 삭제 권장 사항 (100% 중복 임계값)
- 재귀 순회를 통한 빈 폴더 정리

### 주요 데이터 구조

**DriveFile**: Google Drive 메타데이터, 계산된 해시, 경로를 포함한 핵심 파일 표현
**FolderComparisonResult**: 중복 분석을 포함한 두 폴더 비교 결과
**FolderComparisonProgress**: 단계별 상태를 포함한 실시간 진행 추적
**ProgressData**: 재개 가능한 파일 스캔 작업을 위한 체크포인트 시스템

### 동시성 모델

- **전역 DriveService**: 스레드 안전 접근을 위해 sync.RWMutex로 보호되는 단일 인스턴스
- **해시 계산**: 고루틴 기반 병렬 처리를 사용한 설정 가능한 워커 풀 (1-20 워커)
- **백그라운드 작업**: 별도 고루틴에서 폴더 정리, 진행 저장, 장시간 실행 스캔
- **진행 추적**: 데이터베이스 체크포인트와 동기화된 인메모리 상태

### 데이터베이스 스키마

시작 시 자동 마이그레이션되는 SQLite:
- `files`: 파일 메타데이터 및 계산된 해시
- `duplicate_groups`: 중복 파일의 해시 기반 그룹화
- `duplicate_files`: 중복 그룹 내 개별 파일
- `progress`: 재개 가능한 작업을 위한 체크포인트 데이터
- `folder_comparison_tasks`: 재시작 기능을 위한 저장된 비교 작업
- `comparison_result_files`: 폴더 비교의 상세 파일 정보

### API 흐름

1. **전체 드라이브 스캔**: `/scan` → 백그라운드 파일 열거 → 해시 계산 → 중복 검출
2. **폴더 비교**: `/compare-folders` → 병렬 폴더 스캔 → 해시 기반 비교 → 스마트 삭제 권장
3. **파일 작업**: 자동 빈 폴더 정리를 포함한 개별 또는 대량 삭제
4. **진행 모니터링**: 인메모리 상태를 사용한 폴링 엔드포인트를 통한 실시간 업데이트

### 프론트엔드 통합

진행 엔드포인트를 폴링하고 UI 상태를 관리하는 Vanilla JavaScript SPA:
- 장시간 실행 작업 중 실시간 진행 업데이트
- 체크박스 제어 빈 폴더 정리 통합
- 대용량 중복 파일 목록을 위한 페이지네이션
- Google Drive 파일 직접 링크

### 오류 처리

- Google Drive API 속도 제한을 위한 지수 백오프 재시도 로직
- API 할당량 초과 시 부분 결과를 사용한 점진적 저하
- 작업 실패 시 데이터베이스 트랜잭션 롤백
- 고아 데이터베이스 레코드 자동 정리

### 성능 최적화

- HTTP 클라이언트 연결 풀링 및 keep-alive
- 주기적 데이터베이스 저장을 포함한 청크 파일 처리
- 대용량 결과 세트를 위한 메모리 효율적 페이지네이션
- 속도와 리소스 사용량 균형을 위한 설정 가능한 워커 풀
- 폴더 비교 결과의 스마트 캐싱

## 중요 사항

### OAuth 설정 필요
애플리케이션은 Drive API 접근을 위해 Google Cloud Console에서 `credentials.json`이 필요합니다. 첫 실행 시 `token.json`을 생성하는 OAuth 플로우가 트리거됩니다.

### 해시 계산 전략
파일은 전체 다운로드 없이 SHA-256 계산을 위해 스트리밍되지만, 대용량 드라이브의 경우 여전히 상당한 대역폭이 필요합니다. 워커 수는 속도와 리소스 사용량 모두에 영향을 미칩니다.

### 데이터베이스 지속성
SQLite 데이터베이스는 진행 체크포인트를 포함한 모든 상태를 유지합니다. `drive_duplicates.db` 삭제 시 모든 데이터가 재설정되고 전체 재스캔이 필요합니다.

### 폴더 삭제 로직
스마트 폴더 삭제 권장은 100% 중복 임계값에서 트리거됩니다. 시스템은 대상 폴더 내용을 분석하고 모든 파일이 중복일 때만 효율적인 삭제 전략을 제안합니다.

### 빈 폴더 정리
파일 삭제 작업 후 빈 상위 폴더를 재귀적으로 제거하는 체크박스 제어 기능입니다. 개별 및 대량 파일 작업 모두와 통합됩니다.